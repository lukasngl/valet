name: CI

on:
  push:
    branches: [main, ci-test-release]
    tags:
      - "v*"
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ${{ github.repository }}

jobs:
  nix-matrix:
    runs-on: ubuntu-latest
    outputs:
      checks: ${{ steps.set.outputs.checks }}
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - id: set
        run: |
          checks=$(nix flake show --json 2>/dev/null | jq -c '[.checks."x86_64-linux" | to_entries[] | {check: .key}]')
          echo "checks=$checks" >> "$GITHUB_OUTPUT"

  check:
    needs: nix-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.nix-matrix.outputs.checks) }}
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Run ${{ matrix.check }}
        run: |
          out=$(nix build .#checks.x86_64-linux.${{ matrix.check }} --no-link --print-out-paths -L)
          if [ -f "$out/coverage.txt" ]; then
            cp "$out/coverage.txt" "coverage-${{ matrix.check }}.txt"
          fi

      - name: Upload coverage
        if: hashFiles('coverage-*.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.check }}
          path: "coverage-${{ matrix.check }}.txt"

  e2e-test:
    needs: check
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: nix develop .#ci -c bash -e {0}
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Cache devShell
        run: true

      - name: Run Azure e2e tests
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TEST_AZURE_OWNED_APP_OBJECT_ID: ${{ secrets.TEST_AZURE_OWNED_APP_OBJECT_ID }}
          TEST_AZURE_OTHER_APP_OBJECT_ID: ${{ secrets.TEST_AZURE_OTHER_APP_OBJECT_ID }}
        run: gotestsum --format github-actions -- -run TestE2E -timeout 10m -coverpkg=github.com/lukasngl/valet/framework/...,./... -coverprofile=coverage-azure-e2e.txt ./provider-azure/...

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-azure-e2e
          path: coverage-azure-e2e.txt

  coverage:
    needs: [check, e2e-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

  push-nightly:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ci-test-release'
    needs: [check, e2e-test]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [azure]
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Get nightly tag
        id: version
        run: |
          VERSION=$(cat version.txt)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "tag=${VERSION}-dev.${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Write dev version
        run: echo "${{ steps.version.outputs.tag }}" > version.txt

      - name: Build and push image
        run: |
          image_script=$(nix build .#provider-${{ matrix.provider }}-image --no-link --print-out-paths)
          $image_script | nix develop -c skopeo copy \
            --dest-creds=token:${{ secrets.GITHUB_TOKEN }} \
            docker-archive:/dev/stdin \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/provider-${{ matrix.provider }}:${{ steps.version.outputs.tag }}

      - name: Package and push Helm chart
        run: |
          echo "${{ github.token }}" | nix develop -c helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          nix develop -c helm package provider-${{ matrix.provider }}/charts/provider-${{ matrix.provider }} \
            --version ${{ steps.version.outputs.tag }} \
            --app-version ${{ steps.version.outputs.tag }}
          nix develop -c helm push provider-${{ matrix.provider }}-*.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

  push-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [check, e2e-test]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [azure]
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Get version tags
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          MAJOR="$(echo "$VERSION" | cut -d. -f1)"
          MINOR="$(echo "$VERSION" | cut -d. -f2)"
          {
            echo "version=${VERSION}"
            echo "major_minor=${MAJOR}.${MINOR}"
            echo "major=${MAJOR}"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push image
        run: |
          image_script=$(nix build .#provider-${{ matrix.provider }}-image --no-link --print-out-paths)
          $image_script | nix develop -c skopeo copy \
            --dest-creds=token:${{ secrets.GITHUB_TOKEN }} \
            docker-archive:/dev/stdin \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/provider-${{ matrix.provider }}:${{ steps.version.outputs.version }} \
            --additional-tag=${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/provider-${{ matrix.provider }}:${{ steps.version.outputs.major_minor }} \
            --additional-tag=${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/provider-${{ matrix.provider }}:${{ steps.version.outputs.major }}

      - name: Package and push Helm chart
        run: |
          echo "${{ github.token }}" | nix develop -c helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          nix develop -c helm package provider-${{ matrix.provider }}/charts/provider-${{ matrix.provider }} \
            --version ${{ steps.version.outputs.version }} \
            --app-version ${{ steps.version.outputs.version }}
          nix develop -c helm push provider-${{ matrix.provider }}-*.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts
